# Pre-race Scenario UI v2.3

シナリオを入力してベース予測を補正し、結果を確認・保存するUIです。
人間の思考を補助するツールとして設計されています。

## クイックスタート（日次運用）

```bash
# Step 1: 環境チェック（必須）
python scripts/run_pre_race_day.py --date 2024-12-29

# Step 2: UI起動（チェック通過後）
python ui/pre_race/server.py

# Step 3: ブラウザで開く
# http://localhost:8080
```

**デモモードで試す場合:**
```bash
python scripts/run_pre_race_day.py --demo
```

## 日次運用の流れ（3〜5ステップ）

1. **前日: 素材生成**
   ```bash
   python scripts/generate_pre_race_materials.py \
       --db netkeiba.db --date 2024-12-29 \
       --out artifacts/pre_race/2024-12-29
   ```

2. **当日: チェック**
   ```bash
   python scripts/run_pre_race_day.py --date 2024-12-29
   ```

3. **当日: UI起動 → レース選択 → シナリオ入力 → 保存**

## artifacts ディレクトリ規約

```
artifacts/pre_race/
├── demo/                      # デモデータ（git管理）
│   ├── summary_demo.json
│   └── race_demo_001.json
├── 2024-12-29/                # 日付ごとの入力素材（gitignore）
│   ├── summary_2024-12-29.json
│   └── race_202412290605.json
└── outputs/                   # ユーザー保存履歴（gitignore）
    └── 2024-12-29/
        └── 202412290605/
            └── 20241229_150000.json
```

| ディレクトリ | 内容 | git管理 |
|--------------|------|---------|
| `demo/` | UI動作確認用のサンプルデータ | ✓ コミット対象 |
| `YYYY-MM-DD/` | 日付ごとの予測素材（generate_pre_race_materials.py出力） | ✗ gitignore |
| `outputs/` | UI保存結果（シナリオ履歴） | ✗ gitignore |

## バージョン履歴

**v2.3 (Step A/B):**
- 確率差分表示の整合（pt表記）
- エラー時のアクションガイダンス
- 履歴ミニ要約を◎○▲記号に変更
- ワンコマンドチェッカー（run_pre_race_day.py）追加
- デモデータ対応

**v2.2:**
- 構造化理由タグ（カテゴリ別）
- 構造化全体コメント（概況/バイアス/展開/注目）
- WIN/IN3モード切替
- Top-N強調表示

**v2.0:**
- トラックバイアスを2軸に分離（進路バイアス + 脚質バイアス）
- メモからの提案チップ機能（自動反映せず、クリックで反映）
- テーブルヘッダークリックでソート
- レース選択にメタ情報表示
- 全体コメント・馬タグ表示

## 起動方法（手動）

```bash
# プロジェクトルートから
python ui/pre_race/server.py

# ブラウザで http://localhost:8080 にアクセス
```

## 使い方

1. **レース選択**: `artifacts/pre_race/` 以下のレースJSONを選択して読み込み
   - 日付・場所・レース名・距離・頭数などメタ情報が表示されます
2. **シナリオ入力**: ペース/馬場/進路バイアス/脚質バイアス/逃げ想定馬を入力
3. **メモ入力**: キーワードから提案チップが生成されます（クリックで反映）
4. **シナリオを適用**: クリックして補正を実行
5. **結果確認**:
   - 全体コメントでレースの俯瞰説明
   - 順位変化（↑↓）と補正理由を確認
   - 馬タグで各馬の特徴を確認
   - ヘッダークリックでソート可能
6. **結果を保存**: `artifacts/ui_runs/` にJSON出力

## シナリオ入力項目

| 項目 | 値 | 説明 |
|------|-----|------|
| ペース予想 | S/M/H | スロー/ミドル/ハイ |
| 馬場状態 | 良/稍重/重/不良 | 当日の馬場 |
| 進路バイアス | inner/middle/outer/flat | どのラインが伸びるか（内/中央/外/フラット） |
| 脚質バイアス | front/closer/flat | 前残り/差し届き/フラット |
| 逃げ想定馬 | 馬番リスト | カンマ区切り（例: 1, 5） |
| メモ | 自由記述 | キーワードから提案チップを生成 |

## メモからの提案チップ

メモに以下のようなキーワードを入力すると、自動で提案チップが生成されます。
**チップは自動反映されません。クリックしてフォームに反映します。**

### 検出されるキーワード例

| カテゴリ | キーワード例 | 生成されるチップ |
|----------|-------------|-----------------|
| 馬場状態 | 高速馬場、開幕週、パンパン | 馬場：良 |
| 馬場状態 | 道悪、重馬場、力のいる | 馬場：重 |
| 進路バイアス | 内伸び、内ラチ沿い、Aコース | 進路：内寄り |
| 進路バイアス | 外伸び、外差し、内が荒れ | 進路：外寄り |
| 脚質バイアス | 前残り、先行有利、前有利 | 脚質：前寄り |
| 脚質バイアス | 差しが届く、追込有利 | 脚質：差し寄り |
| ペース | スロー、上がり勝負、ヨーイドン | 展開：スロー |
| ペース | ハイペース、消耗戦、逃げ争い | 展開：ハイ |
| 血統 | ディープインパクト、SS系 | 血統言及（needs_feature） |

**矛盾検出**: 「内伸び」と「外伸び」が両方含まれる場合、警告チップが表示されます。

**血統キーワード**: 現在は特徴量化されていないため、補正には使用しません。
将来の特徴量化候補として `needs_feature` フラグ付きで表示されます。

## 補正ロジック

### ペース補正（脚質への影響）

| ペース | 逃げ | 先行 | 差し | 追込 |
|--------|------|------|------|------|
| S（スロー） | +20% | +12% | -8% | -18% |
| M（ミドル） | ±0% | ±0% | ±0% | ±0% |
| H（ハイ） | -20% | -10% | +12% | +22% |

### 脚質バイアス補正（style_bias）

「前が残るか、差しが届くか」に基づく補正

| 脚質バイアス | 逃げ | 先行 | 差し | 追込 |
|--------------|------|------|------|------|
| front（前残り） | +10% | +6% | -5% | -10% |
| flat（フラット） | ±0% | ±0% | ±0% | ±0% |
| closer（差し届き） | -10% | -5% | +6% | +10% |

### 進路バイアス補正（lane_bias）

「どのラインが伸びるか」に基づく補正
**重要: 枠番に直結しない。推定される通り道（lane）に作用**

| 進路バイアス | 内目通過 | 中通過 | 外目通過 |
|--------------|----------|--------|----------|
| inner（内伸び） | +6% | ±0% | -4% |
| middle（中央） | ±0% | +3% | ±0% |
| outer（外伸び） | -4% | ±0% | +6% |
| flat（フラット） | ±0% | ±0% | ±0% |

**進路推定ロジック:**
- 枠番だけでなく、推定脚質も考慮
- 内枠の差し馬は外へ持ち出す傾向 → 中～外目通過と推定
- 外枠の逃げ馬は内へ切れ込む傾向 → 中目通過と推定
- 推定の不確実性はコメント/タグに明示

## 出力例

`artifacts/ui_runs/20241229_150000_202412290605.json`:

```json
{
  "race_id": "202412290605",
  "race_name": "有馬記念",
  "scenario": {
    "pace": "S",
    "track_condition": "良",
    "lane_bias": "inner",
    "style_bias": "front",
    "front_runner_ids": ["2020104567"],
    "notes": "開幕週の高速馬場で内伸び"
  },
  "race_comment": "【有馬記念】芝2500m。予想ペースはスローペース。...",
  "entries": [
    {
      "umaban": 1,
      "name": "テストホース1",
      "base_rank_win": 2,
      "adj_rank_win": 1,
      "rank_change_win": 1,
      "run_style": "先行",
      "lane": "inner_lane",
      "tags": ["先行想定", "内目通過想定"],
      "reasons": ["ペースSで先行有利 (+12%)", "前残りバイアスで有利 (+6%)"]
    }
  ],
  "adjusted_at": "2024-12-29T15:00:00"
}
```

## API エンドポイント

| パス | メソッド | 説明 |
|------|---------|------|
| `/api/list-races` | GET | レース一覧（メタ情報付き） |
| `/api/load-race` | GET | レースデータ読み込み |
| `/api/apply-scenario` | POST | シナリオ補正を適用 |
| `/api/parse-memo` | POST | メモをパースして提案チップを返す |
| `/api/save-result` | POST | 結果をJSONに保存 |

## ディレクトリ構成

```
ui/pre_race/
├── server.py       # HTTPサーバー & APIエンドポイント
├── index.html      # シナリオUI (HTML/JS)
└── README.md       # このファイル

src/ui_pre_race/
├── __init__.py
└── memo_parser.py  # メモパーサーエンジン

config/memo_rules/
└── pre_race_rules.yaml  # メモ解析ルール辞書
```

## 依存関係

- Python 3.11+
- PyYAML（メモパーサー用）
- 追加パッケージは基本不要（標準ライブラリ中心）

## 設計原則

1. **AIは購入判断しない**: 買う/買わないの判断は人間が行う
2. **メモは自動反映しない**: 提案チップをクリックして初めてフォームに反映
3. **枠への直結を避ける**: 進路バイアスは推定される通り道に作用
4. **捏造禁止**: コメント/タグは入力情報から説明可能な範囲に限定

## 注意事項

- このUIは開発用のローカルサーバーです
- 本番環境での使用は想定していません
- 補正ロジックは人間の思考補助用であり、精度は保証しません
