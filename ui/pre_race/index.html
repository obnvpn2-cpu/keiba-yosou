<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-race Scenario UI v2.2</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #1a1a2e;
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 1.5rem;
        }
        header .version {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel-header {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group .helper {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #4a90d9;
            color: white;
        }
        .btn-primary:hover {
            background: #357abd;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .race-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .race-info-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .race-info-item .label {
            font-size: 0.8rem;
            color: #666;
        }
        .race-info-item .value {
            font-weight: bold;
        }

        /* Chips */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 40px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chip-default {
            background: #e3f2fd;
            color: #1565c0;
        }
        .chip-default:hover {
            background: #bbdefb;
        }
        .chip-warning {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffb74d;
        }
        .chip-feature {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .chip-applied {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #66bb6a;
        }
        .chip .chip-icon {
            margin-right: 4px;
        }
        .chip-reason {
            font-size: 0.75rem;
            color: #666;
            margin-left: 4px;
        }

        /* Comment box */
        .race-comment {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Table */
        .horse-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .horse-table th,
        .horse-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .horse-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        .horse-table th:hover {
            background: #e9ecef;
        }
        .horse-table th.sorted-asc::after {
            content: " ‚ñ≤";
            font-size: 0.7rem;
        }
        .horse-table th.sorted-desc::after {
            content: " ‚ñº";
            font-size: 0.7rem;
        }
        .horse-table tr:hover {
            background: #f5f8ff;
        }
        .umaban {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .umaban-1, .umaban-2 { background: #fff; color: #333; border: 1px solid #333; }
        .umaban-3, .umaban-4 { background: #000; }
        .umaban-5, .umaban-6 { background: #f00; }
        .umaban-7, .umaban-8 { background: #00f; }
        .umaban-9, .umaban-10 { background: #0a0; }
        .umaban-11, .umaban-12 { background: #f80; }
        .umaban-13, .umaban-14 { background: #f0f; }
        .umaban-15, .umaban-16, .umaban-17, .umaban-18 { background: #ff0; color: #333; }

        /* Rank change */
        .rank-change {
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        .rank-up {
            color: #27ae60;
        }
        .rank-down {
            color: #e74c3c;
        }
        .rank-neutral {
            color: #999;
        }
        .prob-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prob-bar-bg {
            flex: 1;
            height: 20px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .prob-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #27ae60);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .prob-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
        }
        .reasons {
            font-size: 0.8rem;
            color: #666;
        }
        .reason-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: #e3f2fd;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        .reason-tag.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .reason-tag.negative {
            background: #ffebee;
            color: #c62828;
        }
        .horse-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .horse-tag {
            font-size: 0.7rem;
            padding: 2px 5px;
            background: #f0f0f0;
            border-radius: 3px;
            color: #555;
        }
        .horse-tag.front {
            background: #fff3e0;
            color: #e65100;
        }
        .horse-tag.closer {
            background: #e8f5e9;
            color: #2e7d32;
        }
        /* Profile styles */
        .profile-row {
            display: none;
        }
        .profile-row.expanded {
            display: table-row;
        }
        .profile-cell {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #ddd;
        }
        .profile-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
        }
        .profile-section {
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .profile-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profile-overview {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
        .profile-supplement {
            font-size: 0.9rem;
            color: #555;
        }
        .profile-comments {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .profile-comment {
            font-size: 0.75rem;
            padding: 3px 8px;
            background: #e3f2fd;
            border-radius: 10px;
            color: #1565c0;
        }
        .profile-evidence {
            font-size: 0.85rem;
        }
        .evidence-toggle {
            cursor: pointer;
            color: #4a90d9;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        .evidence-toggle:hover {
            text-decoration: underline;
        }
        .evidence-list {
            display: none;
        }
        .evidence-list.expanded {
            display: block;
        }
        .evidence-item {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.8rem;
        }
        .evidence-item:last-child {
            border-bottom: none;
        }
        .evidence-key {
            font-family: monospace;
            background: #f0f0f0;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        .evidence-value {
            font-weight: 500;
            color: #333;
        }
        .evidence-reason {
            color: #666;
            font-size: 0.75rem;
        }
        .expand-btn {
            cursor: pointer;
            color: #4a90d9;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .expand-btn:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #eee;
            border-top-color: #4a90d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tab-btn.active {
            background: #4a90d9;
            color: white;
            border-color: #4a90d9;
        }

        /* History Panel */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item:hover {
            background: #f5f8ff;
        }
        .history-item.selected {
            background: #e3f2fd;
        }
        .history-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }
        .history-scenario {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .history-scenario .tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            background: #e3f2fd;
            border-radius: 3px;
            color: #1565c0;
        }
        .history-empty {
            padding: 30px;
            text-align: center;
            color: #999;
        }

        /* Error message */
        .error-banner {
            background: #ffebee;
            border-left: 4px solid #e53935;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 0 4px 4px 0;
            color: #c62828;
        }
        .error-banner .title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .error-banner .detail {
            font-size: 0.9rem;
        }

        /* Date/Race selection grid */
        .selection-grid {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 15px;
            align-items: end;
        }
        @media (max-width: 768px) {
            .selection-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .horse-table {
                font-size: 0.8rem;
            }
        }

        /* v2.2 Styles */
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .mode-toggle button {
            padding: 4px 10px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .mode-toggle button.active {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
        }
        .mode-toggle button:hover:not(.active) {
            background: #f3f4f6;
        }

        /* Top-N Toggle */
        .top-n-toggle {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .top-n-toggle label {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .top-n-toggle select {
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 0.85rem;
        }

        /* Top-N Highlight */
        .horse-row.top-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent) !important;
        }
        .horse-row.top-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15), transparent) !important;
        }
        .horse-row.top-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15), transparent) !important;
        }
        .horse-row.top-4, .horse-row.top-5 {
            background: linear-gradient(90deg, rgba(200, 200, 200, 0.08), transparent) !important;
        }
        .horse-row.dim {
            opacity: 0.5;
        }

        /* Probability Change Display */
        .prob-change {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1px;
        }
        .prob-change .values {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
        }
        .prob-change .before {
            color: #9ca3af;
            font-size: 0.75rem;
        }
        .prob-change .arrow {
            color: #9ca3af;
            font-size: 0.7rem;
        }
        .prob-change .after {
            font-weight: 600;
        }
        .prob-change .diff {
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 3px;
        }
        .prob-change .diff.positive {
            color: #16a34a;
            background: rgba(22, 163, 74, 0.1);
        }
        .prob-change .diff.negative {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
        }
        .prob-change .diff.neutral {
            color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
        }

        /* Structured Race Comment */
        .race-comment-structured {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .race-comment-structured .section {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .race-comment-structured .section:last-child {
            border-bottom: none;
        }
        .race-comment-structured .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .race-comment-structured .section-content {
            font-size: 0.9rem;
            color: #374151;
        }
        .race-comment-toggle {
            display: flex;
            justify-content: center;
            padding: 6px;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .race-comment-toggle:hover {
            background: #e5e7eb;
        }
        .race-comment-detail {
            display: none;
        }
        .race-comment-detail.expanded {
            display: block;
        }

        /* History Enhancements */
        .history-item .meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .history-item .has-notes-badge {
            font-size: 0.7rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: #dbeafe;
            color: #1d4ed8;
        }
        .history-item .mini-summary {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }
        .history-viewing-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 10px;
        }
        .history-viewing-badge.hidden {
            display: none;
        }

        /* Chip Categories */
        .chip-category-group {
            margin-bottom: 10px;
        }
        .chip-category-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .chip-category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .chip.chip-negated {
            background: #fef3c7 !important;
            color: #92400e !important;
            border-color: #fcd34d !important;
        }

        /* Structured Reasons */
        .reason-structured {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .reason-cat-tag {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .reason-cat-tag.pace {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .reason-cat-tag.lane_bias {
            background: #dcfce7;
            color: #15803d;
        }
        .reason-cat-tag.style_bias {
            background: #fce7f3;
            color: #be185d;
        }
        .reason-cat-tag.track_condition {
            background: #fef3c7;
            color: #92400e;
        }
        .reason-cat-tag.race_flow {
            background: #f3e8ff;
            color: #7c3aed;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: #4b5563;
        }
        .filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Results header bar */
        .results-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .results-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .results-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Pre-race Scenario UI <span class="version">v2.2</span></h1>
    </header>

    <div class="container">
        <!-- Error Banner (hidden by default) -->
        <div id="errorBanner" class="error-banner" style="display: none;">
            <div class="title">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>
            <div class="detail" id="errorDetail"></div>
        </div>

        <!-- Race Selection Panel -->
        <div class="panel">
            <div class="panel-header">1. „É¨„Éº„ÇπÈÅ∏Êäû</div>
            <div class="selection-grid">
                <div class="form-group">
                    <label for="dateSelect">Êó•‰ªò</label>
                    <select id="dateSelect" onchange="onDateChange()">
                        <option value="">-- Êó•‰ªò„ÇíÈÅ∏Êäû --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="raceSelect">„É¨„Éº„Çπ</label>
                    <select id="raceSelect" onchange="onRaceChange()">
                        <option value="">-- Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="loadRace()">Ë™≠„ÅøËæº„Åø</button>
                </div>
            </div>
            <div id="raceInfo" class="race-info" style="display: none;"></div>
        </div>

        <!-- History Panel (collapsible) -->
        <div class="panel" id="historyPanel">
            <div class="panel-header" style="cursor: pointer;" onclick="toggleHistoryPanel()">
                Â±•Ê≠¥ <span id="historyToggleIcon">‚ñº</span>
            </div>
            <div id="historyContent" style="display: none;">
                <div class="form-row" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="loadHistoryList()">Â±•Ê≠¥„ÇíÊõ¥Êñ∞</button>
                </div>
                <div class="history-list" id="historyList">
                    <div class="history-empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>
            </div>
        </div>

        <!-- Scenario Input Panel -->
        <div class="panel" id="scenarioPanel" style="display: none;">
            <div class="panel-header">2. „Ç∑„Éä„É™„Ç™ÂÖ•Âäõ</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="pace">„Éö„Éº„Çπ‰∫àÊÉ≥</label>
                    <select id="pace">
                        <option value="S">S („Çπ„É≠„Éº)</option>
                        <option value="M" selected>M („Éü„Éâ„É´)</option>
                        <option value="H">H („Éè„Ç§)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trackCondition">È¶¨Â†¥Áä∂ÊÖã</label>
                    <select id="trackCondition">
                        <option value="ËâØ" selected>ËâØ</option>
                        <option value="Á®çÈáç">Á®çÈáç</option>
                        <option value="Èáç">Èáç</option>
                        <option value="‰∏çËâØ">‰∏çËâØ</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="laneBias">ÈÄ≤Ë∑Ø„Éê„Ç§„Ç¢„ÇπÔºà„Å©„ÅÆ„É©„Ç§„É≥„Åå‰º∏„Å≥„Çã„ÅãÔºâ</label>
                    <select id="laneBias">
                        <option value="inner">ÂÜÖ‰º∏„Å≥</option>
                        <option value="middle">‰∏≠Â§Æ„ÅåËâØ„ÅÑ</option>
                        <option value="outer">Â§ñ‰º∏„Å≥</option>
                        <option value="flat" selected>„Éï„É©„ÉÉ„ÉàÔºà„Éê„Ç§„Ç¢„Çπ„Å™„ÅóÔºâ</option>
                    </select>
                    <div class="helper">È¶¨Â†¥„ÅÆ„Å©„ÅÆ‰ΩçÁΩÆ„ÅåËµ∞„Çä„ÇÑ„Åô„ÅÑ„Åã</div>
                </div>
                <div class="form-group">
                    <label for="styleBias">ËÑöË≥™„Éê„Ç§„Ç¢„ÇπÔºàÂâçÊÆã„Çä/Â∑Æ„ÅóÂ±ä„ÅçÔºâ</label>
                    <select id="styleBias">
                        <option value="front">ÂâçÊÆã„ÇäÂÇæÂêë</option>
                        <option value="closer">Â∑Æ„Åó„ÉªËøΩËæº„ÅåÂ±ä„Åè</option>
                        <option value="flat" selected>„Éï„É©„ÉÉ„ÉàÔºà„Éê„Ç§„Ç¢„Çπ„Å™„ÅóÔºâ</option>
                    </select>
                    <div class="helper">ÈÄÉ„Åí„ÉªÂÖàË°å or Â∑Æ„Åó„ÉªËøΩËæº„ÅÆ„Å©„Å°„Çâ„ÅåÊúâÂà©„Åã</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="frontRunners">ÈÄÉ„ÅíÊÉ≥ÂÆöÈ¶¨ÔºàÈ¶¨Áï™„Çí„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ</label>
                    <input type="text" id="frontRunners" placeholder="‰æã: 1, 5, 8">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="notes">„É°„É¢Ôºà„Ç≠„Éº„ÉØ„Éº„Éâ„Åã„ÇâÊèêÊ°à„ÉÅ„ÉÉ„Éó„ÇíÁîüÊàêÔºâ</label>
                    <textarea id="notes" placeholder="‰æã: ÈñãÂπïÈÄ±„ÅÆÈ´òÈÄüÈ¶¨Â†¥„ÅßÂÜÖÊû†„ÄÅÂâçÊúâÂà©„Å´„Å™„Å£„Å¶„Çã„ÄÇÁû¨Áô∫Âäõ„ÅÆ„ÅÇ„Çã„Éá„Ç£„Éº„Éó„Ç§„É≥„Éë„ÇØ„ÉàÁ≥ª„ÅÆË°ÄÁµ±„ÅåÂæóÊÑè„Å™ËªΩ„ÅÑËäù„ÄÇ" oninput="debounceAnalyzeMemo()"></textarea>
                    <div class="helper">ÂÖ•Âäõ„Åô„Çã„Å®ÊèêÊ°à„ÉÅ„ÉÉ„Éó„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„Åß„Éï„Ç©„Éº„É†„Å´ÂèçÊò†„ÄÇ</div>
                </div>
            </div>

            <!-- Suggestion Chips -->
            <div id="chipsContainer" class="chips-container" style="display: none;">
                <span style="color: #666; font-size: 0.85rem;">ÊèêÊ°à„ÉÅ„ÉÉ„Éó: </span>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="applyScenario()">„Ç∑„Éä„É™„Ç™„ÇíÈÅ©Áî®</button>
                <button class="btn btn-secondary" onclick="resetScenario()">„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="resultsPanel" style="display: none;">
            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>3. Ë£úÊ≠£ÁµêÊûú</span>
                <span id="historyViewingBadge" class="history-viewing-badge hidden">Èñ≤Ë¶ß‰∏≠ÔºöÈÅéÂéªÁµêÊûú</span>
            </div>

            <!-- Structured Race Comment (v2.2) -->
            <div id="raceCommentStructured" class="race-comment-structured" style="display: none;">
                <div class="section">
                    <div class="section-title">Ê¶ÇÊ≥Å</div>
                    <div class="section-content" id="commentOverview"></div>
                </div>
                <div class="section">
                    <div class="section-title">„Éê„Ç§„Ç¢„Çπ</div>
                    <div class="section-content" id="commentBias"></div>
                </div>
                <div id="commentDetailSection" class="race-comment-detail">
                    <div class="section">
                        <div class="section-title">Â±ïÈñã</div>
                        <div class="section-content" id="commentFocus"></div>
                    </div>
                    <div class="section">
                        <div class="section-title">Ê≥®ÁõÆ</div>
                        <div class="section-content" id="commentHighlight"></div>
                    </div>
                    <div class="section" id="commentSupplementSection" style="display: none;">
                        <div class="section-title">„É°„É¢Ë£úË∂≥</div>
                        <div class="section-content" id="commentSupplement"></div>
                    </div>
                </div>
                <div class="race-comment-toggle" onclick="toggleRaceCommentDetail()">
                    <span id="commentToggleText">‚ñº Ë©≥Á¥∞„ÇíË°®Á§∫</span>
                </div>
            </div>

            <!-- Legacy Race Comment (hidden but kept for compatibility) -->
            <div id="raceComment" class="race-comment" style="display: none;"></div>

            <!-- Results Header Bar (v2.2) -->
            <div class="results-header-bar">
                <div class="results-header-left">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <button class="active" data-mode="win" onclick="switchMode('win')">WIN</button>
                        <button data-mode="in3" onclick="switchMode('in3')">IN3</button>
                    </div>
                    <!-- Top-N Toggle -->
                    <div class="top-n-toggle">
                        <label>Âº∑Ë™ø:</label>
                        <select id="topNSelect" onchange="onTopNChange()">
                            <option value="0">„Å™„Åó</option>
                            <option value="3" selected>Top 3</option>
                            <option value="5">Top 5</option>
                        </select>
                    </div>
                </div>
                <div class="results-header-right">
                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filterTopNOnly" onchange="onFilterChange()">
                            ‰∏ä‰Ωç„ÅÆ„ÅøË°®Á§∫
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filterBigChange" onchange="onFilterChange()">
                            Â§âÂåñÂ§ß„Åç„ÅÑÈ†Ü
                        </label>
                    </div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="horse-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th data-sort="umaban">Êû†</th>
                            <th data-sort="name">È¶¨Âêç</th>
                            <th data-sort="jockey">È®éÊâã</th>
                            <th data-sort="run_style">ËÑöË≥™</th>
                            <th data-sort="tags">„Çø„Ç∞</th>
                            <th data-sort="base_rank">„Éô„Éº„ÇπÈ†Ü</th>
                            <th data-sort="adj_rank">Ë£úÊ≠£È†Ü</th>
                            <th data-sort="rank_change">Â§âÂåñ</th>
                            <th data-sort="prob_change">Á¢∫ÁéáÂ§âÂåñ</th>
                            <th>Ë£úÊ≠£ÁêÜÁî±</th>
                            <th>Ë©≥Á¥∞</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="saveResult()">ÁµêÊûú„Çí‰øùÂ≠ò</button>
            </div>
            <div id="saveStatus"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <h3>„É¨„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            <p>artifacts/pre_race/ „Å´„ÅÇ„Çã„É¨„Éº„ÇπJSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô</p>
        </div>
    </div>

    <script>
        // Global state
        let currentRaceData = null;
        let adjustedResult = null;
        let currentTab = 'win';
        let currentMode = 'win';  // v2.2: mode toggle
        let currentSort = { key: 'umaban', order: 'asc' };
        let appliedChips = new Set();
        let memoDebounceTimer = null;
        let selectedDate = '';
        let selectedRaceId = '';
        let isViewingHistory = false;  // v2.2: history viewing state
        let topNHighlight = 3;  // v2.2: top-N highlight setting
        let filterTopNOnly = false;  // v2.2: filter options
        let filterBigChange = false;

        // LocalStorage keys
        const LS_KEY_DATE = 'prerace_last_date';
        const LS_KEY_RACE = 'prerace_last_race';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDateList();
            setupTableHeaders();
        });

        // Error handling
        function showError(message, detail = '') {
            const banner = document.getElementById('errorBanner');
            const detailEl = document.getElementById('errorDetail');
            detailEl.textContent = detail || message;
            banner.style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 10000);
        }

        function hideError() {
            document.getElementById('errorBanner').style.display = 'none';
        }

        // Setup table header click sorting
        function setupTableHeaders() {
            document.querySelectorAll('.horse-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (currentSort.key === key) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = key;
                        currentSort.order = 'asc';
                    }
                    updateSortIndicators();
                    if (adjustedResult) {
                        displayResults(adjustedResult);
                    }
                });
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('.horse-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const activeTh = document.querySelector(`.horse-table th[data-sort="${currentSort.key}"]`);
            if (activeTh) {
                activeTh.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        // Load date list from server
        async function loadDateList() {
            try {
                const response = await fetch('/api/list-dates');
                const data = await response.json();

                const select = document.getElementById('dateSelect');
                select.innerHTML = '<option value="">-- Êó•‰ªò„ÇíÈÅ∏Êäû --</option>';

                if (data.dates && data.dates.length > 0) {
                    data.dates.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.date;
                        option.textContent = `${d.date} (${d.n_races}„É¨„Éº„Çπ)`;
                        select.appendChild(option);
                    });

                    // Restore last selection from localStorage
                    const lastDate = localStorage.getItem(LS_KEY_DATE);
                    const lastRace = localStorage.getItem(LS_KEY_RACE);

                    if (lastDate && data.dates.some(d => d.date === lastDate)) {
                        select.value = lastDate;
                        await onDateChange(lastRace);
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "(Êó•‰ªò„Éï„Ç©„É´„ÉÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì)";
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load date list:', error);
                showError('Êó•‰ªò‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
            }
        }

        // When date selection changes
        async function onDateChange(restoreRaceId = null) {
            const dateSelect = document.getElementById('dateSelect');
            const raceSelect = document.getElementById('raceSelect');
            selectedDate = dateSelect.value;

            if (!selectedDate) {
                raceSelect.innerHTML = '<option value="">-- Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>';
                return;
            }

            // Save to localStorage
            localStorage.setItem(LS_KEY_DATE, selectedDate);

            // Load races for selected date
            try {
                const response = await fetch(`/api/list-races?date=${encodeURIComponent(selectedDate)}`);
                const data = await response.json();

                raceSelect.innerHTML = '<option value="">-- „É¨„Éº„Çπ„ÇíÈÅ∏Êäû --</option>';

                if (data.races && data.races.length > 0) {
                    data.races.forEach(race => {
                        const option = document.createElement('option');
                        option.value = race.path;
                        option.dataset.raceId = race.race_id;
                        option.textContent = race.label || `${race.race_id}`;
                        raceSelect.appendChild(option);
                    });

                    // Restore race selection if provided
                    if (restoreRaceId) {
                        const matchOption = Array.from(raceSelect.options).find(
                            opt => opt.dataset.raceId === restoreRaceId
                        );
                        if (matchOption) {
                            raceSelect.value = matchOption.value;
                            onRaceChange();
                        }
                    }
                } else if (data.error) {
                    showError('„É¨„Éº„Çπ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó', data.error);
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "(„É¨„Éº„Çπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì)";
                    raceSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load race list:', error);
                showError('„É¨„Éº„Çπ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
            }
        }

        // When race selection changes
        function onRaceChange() {
            const raceSelect = document.getElementById('raceSelect');
            const selectedOption = raceSelect.options[raceSelect.selectedIndex];

            if (selectedOption && selectedOption.dataset.raceId) {
                selectedRaceId = selectedOption.dataset.raceId;
                localStorage.setItem(LS_KEY_RACE, selectedRaceId);
            }
        }

        // Legacy function for backward compatibility
        async function loadRaceList() {
            await loadDateList();
        }

        // Load selected race
        async function loadRace() {
            const select = document.getElementById('raceSelect');
            const path = select.value;

            if (!path) {
                showError('„É¨„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            hideError();

            try {
                const response = await fetch(`/api/load-race?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (data.error) {
                    showError('„É¨„Éº„Çπ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó', data.error);
                    return;
                }

                currentRaceData = data;
                displayRaceInfo(data);
                document.getElementById('scenarioPanel').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'none';

                // Reset scenario form
                resetScenario();

            } catch (error) {
                console.error('Failed to load race:', error);
                showError('„É¨„Éº„Çπ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
            }
        }

        // Display race info
        function displayRaceInfo(data) {
            const infoDiv = document.getElementById('raceInfo');
            infoDiv.innerHTML = `
                <div class="race-info-item">
                    <div class="label">„É¨„Éº„ÇπID</div>
                    <div class="value">${data.race_id || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">Êó•‰ªò</div>
                    <div class="value">${data.date || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">Â†¥ÊâÄ</div>
                    <div class="value">${data.place || '-'} ${data.race_no || ''}R</div>
                </div>
                <div class="race-info-item">
                    <div class="label">„É¨„Éº„ÇπÂêç</div>
                    <div class="value">${data.name || data.race_name || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">Ë∑ùÈõ¢</div>
                    <div class="value">${data.distance || '-'}m ${data.course || ''}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">Âá∫Ëµ∞È†≠Êï∞</div>
                    <div class="value">${data.entries ? data.entries.length : 0}È†≠</div>
                </div>
            `;
            infoDiv.style.display = 'grid';
        }

        // Debounced memo analysis
        function debounceAnalyzeMemo() {
            if (memoDebounceTimer) {
                clearTimeout(memoDebounceTimer);
            }
            memoDebounceTimer = setTimeout(analyzeMemo, 500);
        }

        // Analyze memo and generate chips
        async function analyzeMemo() {
            const memo = document.getElementById('notes').value;
            const container = document.getElementById('chipsContainer');

            if (!memo.trim()) {
                container.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/parse-memo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memo: memo }),
                });

                const data = await response.json();

                if (data.error) {
                    console.error('Memo parse error:', data.error);
                    return;
                }

                displayChips(data.chips || []);

            } catch (error) {
                console.error('Failed to analyze memo:', error);
            }
        }

        // Display suggestion chips (v2.2: organized by category)
        function displayChips(chips) {
            const container = document.getElementById('chipsContainer');

            if (chips.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '';

            // v2.2: Group chips by category
            const categoryOrder = ['track_condition', 'lane_bias', 'style_bias', 'pace', 'frame_hint', 'race_flow', 'pedigree', 'advisory', 'other'];
            const categoryLabels = {
                'track_condition': 'È¶¨Â†¥',
                'lane_bias': '„Éê„Ç§„Ç¢„Çπ(ÈÄ≤Ë∑Ø)',
                'style_bias': '„Éê„Ç§„Ç¢„Çπ(ËÑöË≥™)',
                'pace': '„Éö„Éº„Çπ',
                'frame_hint': 'Êû†„Éí„É≥„Éà(Ê≥®ÊÑè)',
                'race_flow': 'Â±ïÈñã',
                'pedigree': 'Ë°ÄÁµ±',
                'advisory': 'Ê≥®ÊÑè',
                'other': '„Åù„ÅÆ‰ªñ'
            };

            // Group chips
            const groups = {};
            chips.forEach(chip => {
                const cat = chip.category || 'other';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(chip);
            });

            // Render by category order
            categoryOrder.forEach(cat => {
                if (!groups[cat] || groups[cat].length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'chip-category-group';

                // Category label
                const labelDiv = document.createElement('div');
                labelDiv.className = 'chip-category-label';
                labelDiv.textContent = categoryLabels[cat] || cat;
                groupDiv.appendChild(labelDiv);

                // Chips container
                const chipsDiv = document.createElement('div');
                chipsDiv.className = 'chip-category-chips';

                groups[cat].forEach(chip => {
                    const chipEl = document.createElement('span');
                    chipEl.className = 'chip';

                    // v2.2: Check if this is a negated chip
                    const isNegated = chip.label && (chip.label.includes('Âê¶ÂÆö') || chip.label.includes('„Åß„ÅØ„Å™„ÅÑ'));

                    if (isNegated) {
                        chipEl.className += ' chip-negated chip-warning';
                        chipEl.innerHTML = chip.label;
                        chipEl.title = 'Âê¶ÂÆöË°®Áèæ„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„ÅüÔºàÂèçÂØæ„ÅÆÊé®Ë´ñ„ÅØ„Åó„Åæ„Åõ„ÇìÔºâ';
                    } else if (chip.is_warning) {
                        chipEl.className += ' chip-warning';
                        chipEl.innerHTML = `<span class="chip-icon">‚ö†Ô∏è</span>${chip.label}`;
                    } else if (chip.needs_feature) {
                        chipEl.className += ' chip-feature';
                        chipEl.innerHTML = `<span class="chip-icon">üìå</span>${chip.label}`;
                        chipEl.title = 'Â∞ÜÊù•ÁâπÂæ¥ÈáèÂåñÂÄôË£úÔºàÁèæÂú®„ÅØË£úÊ≠£„Å´‰ΩøÁî®„Åó„Åæ„Åõ„ÇìÔºâ';
                    } else if (appliedChips.has(chip.id)) {
                        chipEl.className += ' chip-applied';
                        chipEl.innerHTML = `<span class="chip-icon">‚úì</span>${chip.label}`;
                    } else {
                        chipEl.className += ' chip-default';
                        chipEl.innerHTML = chip.label;
                        chipEl.onclick = () => applyChip(chip);
                    }

                    chipsDiv.appendChild(chipEl);
                });

                groupDiv.appendChild(chipsDiv);
                container.appendChild(groupDiv);
            });
        }

        // Apply chip to form
        function applyChip(chip) {
            const payload = chip.apply_payload || {};

            if (payload.track_condition) {
                document.getElementById('trackCondition').value = payload.track_condition;
            }
            if (payload.lane_bias) {
                document.getElementById('laneBias').value = payload.lane_bias;
            }
            if (payload.style_bias) {
                document.getElementById('styleBias').value = payload.style_bias;
            }
            if (payload.pace) {
                document.getElementById('pace').value = payload.pace;
            }

            appliedChips.add(chip.id);

            // Re-analyze to update chip display
            analyzeMemo();
        }

        // Apply scenario
        async function applyScenario() {
            if (!currentRaceData) {
                showError('„É¨„Éº„Çπ„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // v2.2: Reset history viewing state
            isViewingHistory = false;
            hideError();

            // Parse front runners
            const frontRunnersInput = document.getElementById('frontRunners').value;
            const frontRunnerUmabans = frontRunnersInput
                .split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));

            // Map umaban to horse_id
            const frontRunnerIds = currentRaceData.entries
                .filter(e => frontRunnerUmabans.includes(e.umaban))
                .map(e => e.horse_id);

            const scenario = {
                pace: document.getElementById('pace').value,
                track_condition: document.getElementById('trackCondition').value,
                lane_bias: document.getElementById('laneBias').value,
                style_bias: document.getElementById('styleBias').value,
                front_runner_ids: frontRunnerIds,
                notes: document.getElementById('notes').value,
            };

            try {
                const response = await fetch('/api/apply-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        race_data: currentRaceData,
                        scenario: scenario,
                    }),
                });

                const result = await response.json();

                if (result.error) {
                    showError('„Ç∑„Éä„É™„Ç™ÈÅ©Áî®„Å´Â§±Êïó', result.error);
                    return;
                }

                adjustedResult = result;
                displayResults(result);
                document.getElementById('resultsPanel').style.display = 'block';

            } catch (error) {
                console.error('Failed to apply scenario:', error);
                showError('„Ç∑„Éä„É™„Ç™ÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
            }
        }

        // Switch between win/in3 tabs (v2.1 legacy - redirect to switchMode)
        function switchTab(tab) {
            switchMode(tab);
        }

        // v2.2: Switch mode (WIN/IN3)
        function switchMode(mode) {
            currentMode = mode;
            currentTab = mode; // Keep backward compatibility
            document.querySelectorAll('.mode-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            if (adjustedResult) {
                displayResults(adjustedResult);
            }
        }

        // v2.2: Toggle race comment detail section
        function toggleRaceCommentDetail() {
            const detail = document.getElementById('commentDetailSection');
            const toggleText = document.getElementById('commentToggleText');
            const isExpanded = detail.classList.contains('expanded');

            detail.classList.toggle('expanded');
            toggleText.textContent = isExpanded ? '‚ñº Ë©≥Á¥∞„ÇíË°®Á§∫' : '‚ñ≤ Ë©≥Á¥∞„ÇíÈö†„Åô';
        }

        // v2.2: Top-N highlight change
        function onTopNChange() {
            topNHighlight = parseInt(document.getElementById('topNSelect').value) || 0;
            if (adjustedResult) {
                displayResults(adjustedResult);
            }
        }

        // v2.2: Filter change
        function onFilterChange() {
            filterTopNOnly = document.getElementById('filterTopNOnly').checked;
            filterBigChange = document.getElementById('filterBigChange').checked;
            if (adjustedResult) {
                displayResults(adjustedResult);
            }
        }

        // Display results (v2.2 updated)
        function displayResults(result) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            // v2.2: Display structured race comment
            const structuredComment = result.race_comment_structured;
            const structuredDiv = document.getElementById('raceCommentStructured');

            if (structuredComment) {
                document.getElementById('commentOverview').textContent = structuredComment.overview || '';
                document.getElementById('commentBias').textContent = structuredComment.bias || '';
                document.getElementById('commentFocus').textContent = structuredComment.focus || '';
                document.getElementById('commentHighlight').textContent = structuredComment.highlight || '';

                if (structuredComment.supplement) {
                    document.getElementById('commentSupplement').textContent = structuredComment.supplement;
                    document.getElementById('commentSupplementSection').style.display = 'block';
                } else {
                    document.getElementById('commentSupplementSection').style.display = 'none';
                }

                structuredDiv.style.display = 'block';
            } else {
                structuredDiv.style.display = 'none';

                // Fallback to legacy comment
                const commentDiv = document.getElementById('raceComment');
                if (result.race_comment) {
                    commentDiv.textContent = result.race_comment;
                    commentDiv.style.display = 'block';
                } else {
                    commentDiv.style.display = 'none';
                }
            }

            // v2.2: Update history viewing badge
            const badge = document.getElementById('historyViewingBadge');
            if (isViewingHistory) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Sort entries
            let entries = [...result.entries];

            // v2.2: Apply filters
            if (filterBigChange) {
                // Sort by magnitude of rank change
                entries.sort((a, b) => {
                    const changeA = Math.abs(currentMode === 'win' ? (a.rank_change_win || 0) : (a.rank_change_in3 || 0));
                    const changeB = Math.abs(currentMode === 'win' ? (b.rank_change_win || 0) : (b.rank_change_in3 || 0));
                    return changeB - changeA;
                });
            } else {
                sortEntries(entries);
            }

            // v2.2: Compute adjusted ranks for highlighting
            const rankedEntries = [...entries].sort((a, b) => {
                const rankA = currentMode === 'win' ? (a.adj_rank_win || 99) : (a.adj_rank_in3 || 99);
                const rankB = currentMode === 'win' ? (b.adj_rank_win || 99) : (b.adj_rank_in3 || 99);
                return rankA - rankB;
            });
            const topNIds = new Set(rankedEntries.slice(0, topNHighlight).map(e => e.horse_id));

            // v2.2: Filter to top-N only if enabled
            if (filterTopNOnly && topNHighlight > 0) {
                entries = entries.filter(e => topNIds.has(e.horse_id));
            }

            entries.forEach((entry, idx) => {
                const row = document.createElement('tr');
                row.className = 'horse-row';
                const profileRowId = `profile-row-${entry.umaban}`;

                // Get values based on current mode
                const baseRank = currentMode === 'win' ? entry.base_rank_win : entry.base_rank_in3;
                const adjRank = currentMode === 'win' ? entry.adj_rank_win : entry.adj_rank_in3;
                const rankChange = currentMode === 'win' ? entry.rank_change_win : entry.rank_change_in3;
                const baseP = currentMode === 'win' ? entry.base_p_win : entry.base_p_in3;
                const adjP = currentMode === 'win' ? entry.adj_p_win : entry.adj_p_in3;

                // v2.2: Top-N highlighting
                if (topNHighlight > 0 && adjRank <= topNHighlight) {
                    row.classList.add(`top-${adjRank}`);
                } else if (filterTopNOnly) {
                    row.classList.add('dim');
                }

                // Rank change styling
                let rankChangeClass = 'rank-neutral';
                let rankChangeText = '‚Üí';
                if (rankChange > 0) {
                    rankChangeClass = 'rank-up';
                    rankChangeText = `‚Üë${rankChange}`;
                } else if (rankChange < 0) {
                    rankChangeClass = 'rank-down';
                    rankChangeText = `‚Üì${Math.abs(rankChange)}`;
                }

                // v2.2: Probability change display
                const probDiff = (adjP || 0) - (baseP || 0);
                let diffClass = 'neutral';
                let diffSign = '';
                if (probDiff > 0.001) {
                    diffClass = 'positive';
                    diffSign = '+';
                } else if (probDiff < -0.001) {
                    diffClass = 'negative';
                }

                const probChangeHtml = `
                    <div class="prob-change">
                        <div class="values">
                            <span class="before">${((baseP || 0) * 100).toFixed(1)}%</span>
                            <span class="arrow">‚Üí</span>
                            <span class="after">${((adjP || 0) * 100).toFixed(1)}%</span>
                        </div>
                        <span class="diff ${diffClass}">${diffSign}${(probDiff * 100).toFixed(2)}%</span>
                    </div>
                `;

                // v2.2: Structured reason tags
                const reasonsStructured = entry.reasons_structured || {};
                let reasonTagsHtml = '';

                if (Object.keys(reasonsStructured).length > 0) {
                    reasonTagsHtml = '<div class="reason-structured">';
                    for (const [cat, data] of Object.entries(reasonsStructured)) {
                        const effectIcon = data.effect === 'positive' ? '‚ñ≤' : (data.effect === 'negative' ? '‚ñº' : '');
                        reasonTagsHtml += `<span class="reason-cat-tag ${cat}">${effectIcon} ${data.text}</span>`;
                    }
                    reasonTagsHtml += '</div>';
                } else {
                    // Fallback to legacy reasons
                    reasonTagsHtml = (entry.reasons || []).map(r => {
                        const isPositive = r.includes('ÊúâÂà©') || r.includes('ÈÄÉ„ÅíÊÉ≥ÂÆö');
                        const isNegative = r.includes('‰∏çÂà©') || r.includes('Ê∏õË°∞');
                        let tagClass = 'reason-tag';
                        if (isPositive) tagClass += ' positive';
                        if (isNegative) tagClass += ' negative';
                        return `<span class="${tagClass}">${r}</span>`;
                    }).join('');
                }

                // Horse tags (v2.2: with priority ordering)
                const tagOrder = ['ÈÄÉ„ÅíÊÉ≥ÂÆö', 'ÂÖàË°åÊÉ≥ÂÆö', 'Â∑Æ„ÅóÊÉ≥ÂÆö', 'ËøΩËæºÊÉ≥ÂÆö', 'ËøëËµ∞Â•ΩË™ø', 'Êú´ËÑö‚óã', 'Ë∑ùÈõ¢‚óé', '„Ç≥„Éº„Çπ‚óé'];
                const sortedTags = [...(entry.tags || [])].sort((a, b) => {
                    const idxA = tagOrder.findIndex(t => a.includes(t.replace('ÊÉ≥ÂÆö', '')));
                    const idxB = tagOrder.findIndex(t => b.includes(t.replace('ÊÉ≥ÂÆö', '')));
                    return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
                });

                const horseTags = sortedTags.map(t => {
                    let tagClass = 'horse-tag';
                    if (t.includes('ÈÄÉ„Åí') || t.includes('ÂÖàË°å')) tagClass += ' front';
                    if (t.includes('Â∑Æ„Åó') || t.includes('ËøΩËæº')) tagClass += ' closer';
                    return `<span class="${tagClass}">${t}</span>`;
                }).join('');

                // Check if profile exists
                const hasProfile = entry.profile && (entry.profile.overview || entry.profile.comments?.length > 0);

                row.innerHTML = `
                    <td><span class="umaban umaban-${entry.umaban}">${entry.umaban}</span></td>
                    <td><strong>${entry.name || '-'}</strong></td>
                    <td>${entry.jockey || '-'}</td>
                    <td>${entry.run_style || '-'}</td>
                    <td><div class="horse-tags">${horseTags || '-'}</div></td>
                    <td style="text-align: center;">${baseRank || '-'}</td>
                    <td style="text-align: center; font-weight: bold;">${adjRank || '-'}</td>
                    <td class="rank-change ${rankChangeClass}">${rankChangeText}</td>
                    <td>${probChangeHtml}</td>
                    <td class="reasons">${reasonTagsHtml || '-'}</td>
                    <td>
                        ${hasProfile
                            ? `<span class="expand-btn" onclick="toggleProfile('${profileRowId}')" id="btn-${profileRowId}">Ë©≥Á¥∞ ‚ñº</span>`
                            : '-'
                        }
                    </td>
                `;

                tbody.appendChild(row);

                // Add profile row (hidden by default) - v2.2: improved layout
                if (hasProfile) {
                    const profileRow = document.createElement('tr');
                    profileRow.id = profileRowId;
                    profileRow.className = 'profile-row';

                    const profile = entry.profile;
                    const evidenceId = `evidence-${entry.umaban}`;

                    // v2.2: Sort and prioritize comments
                    const commentOrder = ['ËøëËµ∞Â•ΩË™ø', 'ËøëËµ∞ÂÆâÂÆö', 'Êú´ËÑöÈã≠„ÅÑ', 'Áû¨Áô∫Âäõ„ÅÇ„Çä', 'Ë∑ùÈõ¢‚óé', '„Ç≥„Éº„Çπ‚óé', 'G1ÁµåÈ®ì'];
                    const sortedComments = [...(profile.comments || [])].sort((a, b) => {
                        const idxA = commentOrder.findIndex(c => a.includes(c));
                        const idxB = commentOrder.findIndex(c => b.includes(c));
                        return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
                    });

                    const commentsHtml = sortedComments.map(c =>
                        `<span class="profile-comment">${c}</span>`
                    ).join('');

                    // Build evidence HTML
                    const evidenceHtml = (profile.evidence || []).map(e =>
                        `<div class="evidence-item">
                            <span class="evidence-key">${e.key}</span>:
                            <span class="evidence-value">${e.value}</span>
                            <div class="evidence-reason">${e.reason}</div>
                        </div>`
                    ).join('');

                    profileRow.innerHTML = `
                        <td colspan="11" class="profile-cell">
                            <div class="profile-content">
                                <div class="profile-section">
                                    <div class="profile-section-title">Ê¶ÇË¶Å</div>
                                    <div class="profile-overview">${profile.overview || 'ÊÉÖÂ†±„Å™„Åó'}</div>
                                    ${profile.supplement ? `<div class="profile-supplement" style="margin-top: 8px;">${profile.supplement}</div>` : ''}
                                </div>
                                <div class="profile-section">
                                    <div class="profile-section-title">„Ç≥„É°„É≥„Éà</div>
                                    <div class="profile-comments">${commentsHtml || '<span style="color: #999;">„Å™„Åó</span>'}</div>
                                </div>
                                ${(profile.evidence && profile.evidence.length > 0) ? `
                                <div class="profile-section" style="grid-column: 1 / -1;">
                                    <div class="profile-section-title">Ê†πÊã† (Evidence)</div>
                                    <div class="profile-evidence">
                                        <div class="evidence-toggle" onclick="toggleEvidence('${evidenceId}')">
                                            ‚ñ∂ Ê†πÊã†„ÇíË°®Á§∫ (${profile.evidence.length}‰ª∂)
                                        </div>
                                        <div id="${evidenceId}" class="evidence-list">
                                            ${evidenceHtml}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </td>
                    `;

                    tbody.appendChild(profileRow);
                }
            });

            updateSortIndicators();
        }

        // Toggle profile row visibility
        function toggleProfile(rowId) {
            const row = document.getElementById(rowId);
            const btn = document.getElementById(`btn-${rowId}`);
            if (row) {
                row.classList.toggle('expanded');
                if (btn) {
                    btn.textContent = row.classList.contains('expanded') ? 'Ë©≥Á¥∞ ‚ñ≤' : 'Ë©≥Á¥∞ ‚ñº';
                }
            }
        }

        // Toggle evidence list visibility
        function toggleEvidence(evidenceId) {
            const list = document.getElementById(evidenceId);
            if (list) {
                list.classList.toggle('expanded');
                const toggle = list.previousElementSibling;
                if (toggle) {
                    const count = list.children.length;
                    toggle.textContent = list.classList.contains('expanded')
                        ? `‚ñº Ê†πÊã†„ÇíÈö†„Åô (${count}‰ª∂)`
                        : `‚ñ∂ Ê†πÊã†„ÇíË°®Á§∫ (${count}‰ª∂)`;
                }
            }
        }

        // Sort entries
        function sortEntries(entries) {
            const key = currentSort.key;
            const order = currentSort.order;

            entries.sort((a, b) => {
                let valA, valB;

                switch (key) {
                    case 'umaban':
                        valA = a.umaban || 0;
                        valB = b.umaban || 0;
                        break;
                    case 'name':
                        valA = a.name || '';
                        valB = b.name || '';
                        break;
                    case 'jockey':
                        valA = a.jockey || '';
                        valB = b.jockey || '';
                        break;
                    case 'run_style':
                        const styleOrder = { 'ÈÄÉ„Åí': 1, 'ÂÖàË°å': 2, 'Â∑Æ„Åó': 3, 'ËøΩËæº': 4, '‰∏çÊòé': 5 };
                        valA = styleOrder[a.run_style] || 5;
                        valB = styleOrder[b.run_style] || 5;
                        break;
                    case 'tags':
                        valA = (a.tags || []).length;
                        valB = (b.tags || []).length;
                        break;
                    case 'base_rank':
                        valA = currentTab === 'win' ? (a.base_rank_win || 99) : (a.base_rank_in3 || 99);
                        valB = currentTab === 'win' ? (b.base_rank_win || 99) : (b.base_rank_in3 || 99);
                        break;
                    case 'adj_rank':
                        valA = currentTab === 'win' ? (a.adj_rank_win || 99) : (a.adj_rank_in3 || 99);
                        valB = currentTab === 'win' ? (b.adj_rank_win || 99) : (b.adj_rank_in3 || 99);
                        break;
                    case 'rank_change':
                        valA = currentTab === 'win' ? (a.rank_change_win || 0) : (a.rank_change_in3 || 0);
                        valB = currentTab === 'win' ? (b.rank_change_win || 0) : (b.rank_change_in3 || 0);
                        break;
                    case 'base_p':
                        valA = currentTab === 'win' ? (a.base_p_win || 0) : (a.base_p_in3 || 0);
                        valB = currentTab === 'win' ? (b.base_p_win || 0) : (b.base_p_in3 || 0);
                        break;
                    case 'adj_p':
                        valA = currentTab === 'win' ? (a.adj_p_win || 0) : (a.adj_p_in3 || 0);
                        valB = currentTab === 'win' ? (b.adj_p_win || 0) : (b.adj_p_in3 || 0);
                        break;
                    default:
                        valA = a.umaban || 0;
                        valB = b.umaban || 0;
                }

                if (typeof valA === 'string') {
                    return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return order === 'asc' ? valA - valB : valB - valA;
            });
        }

        // Reset scenario
        function resetScenario() {
            document.getElementById('pace').value = 'M';
            document.getElementById('trackCondition').value = 'ËâØ';
            document.getElementById('laneBias').value = 'flat';
            document.getElementById('styleBias').value = 'flat';
            document.getElementById('frontRunners').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('chipsContainer').style.display = 'none';
            adjustedResult = null;
            appliedChips.clear();
        }

        // Save result
        async function saveResult() {
            if (!adjustedResult) {
                alert('‰øùÂ≠ò„Åô„ÇãÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result: adjustedResult }),
                });

                const data = await response.json();

                const statusDiv = document.getElementById('saveStatus');
                if (data.status === 'saved') {
                    statusDiv.innerHTML = `<div class="status-message status-success">‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ${data.path}</div>`;
                    // Refresh history list
                    loadHistoryList();
                } else if (data.error) {
                    statusDiv.innerHTML = `<div class="status-message status-error">„Ç®„É©„Éº: ${data.error}</div>`;
                }

                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('Failed to save result:', error);
                showError('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error.message);
            }
        }

        // ============================
        // History Panel Functions
        // ============================

        function toggleHistoryPanel() {
            const content = document.getElementById('historyContent');
            const icon = document.getElementById('historyToggleIcon');
            const isExpanded = content.style.display !== 'none';

            content.style.display = isExpanded ? 'none' : 'block';
            icon.textContent = isExpanded ? '‚ñº' : '‚ñ≤';

            if (!isExpanded) {
                loadHistoryList();
            }
        }

        async function loadHistoryList() {
            const listEl = document.getElementById('historyList');

            try {
                // Optionally filter by current date/race
                let url = '/api/list-history';
                if (selectedDate) {
                    url += `?date=${encodeURIComponent(selectedDate)}`;
                    if (selectedRaceId) {
                        url += `&race_id=${encodeURIComponent(selectedRaceId)}`;
                    }
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    listEl.innerHTML = '';
                    data.history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.onclick = () => loadHistoryItem(item.path);

                        // Format timestamp
                        const timestamp = item.timestamp || '';
                        const formattedTime = timestamp.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5:$6');

                        // Build scenario tags
                        const scenario = item.scenario || {};
                        const scenarioTags = [];
                        if (scenario.pace) scenarioTags.push(`„Éö„Éº„Çπ:${scenario.pace}`);
                        if (scenario.lane_bias && scenario.lane_bias !== 'flat') {
                            const biasLabel = { inner: 'ÂÜÖ‰º∏„Å≥', outer: 'Â§ñ‰º∏„Å≥', middle: '‰∏≠Â§Æ' }[scenario.lane_bias] || scenario.lane_bias;
                            scenarioTags.push(biasLabel);
                        }
                        if (scenario.style_bias && scenario.style_bias !== 'flat') {
                            const styleLabel = { front: 'ÂâçÊÆã„Çä', closer: 'Â∑Æ„ÅóÂêë„Åç' }[scenario.style_bias] || scenario.style_bias;
                            scenarioTags.push(styleLabel);
                        }
                        if (scenario.track_condition && scenario.track_condition !== 'ËâØ') {
                            scenarioTags.push(`È¶¨Â†¥:${scenario.track_condition}`);
                        }

                        // v2.2: Add has_notes badge and mini_summary
                        const hasNotesBadge = item.has_notes ? '<span class="has-notes-badge">„É°„É¢„ÅÇ„Çä</span>' : '';
                        const miniSummary = item.rank_mini_summary ? `<div class="mini-summary">${item.rank_mini_summary}</div>` : '';

                        div.innerHTML = `
                            <div class="meta">
                                <strong>${item.place || ''} ${item.race_no ? item.race_no + 'R' : ''} ${item.race_name || item.race_id}</strong>
                                ${hasNotesBadge}
                            </div>
                            <div class="history-meta">${item.date} | ${formattedTime}</div>
                            ${scenarioTags.length > 0 ? `
                                <div class="history-scenario">
                                    ${scenarioTags.map(t => `<span class="tag">${t}</span>`).join('')}
                                </div>
                            ` : ''}
                            ${miniSummary}
                        `;

                        listEl.appendChild(div);
                    });
                } else {
                    listEl.innerHTML = '<div class="history-empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                listEl.innerHTML = `<div class="history-empty">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
            }
        }

        async function loadHistoryItem(path) {
            try {
                const response = await fetch(`/api/load-history?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (data.error) {
                    showError('Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó', data.error);
                    return;
                }

                // v2.2: Set history viewing state
                isViewingHistory = true;

                // Set as adjusted result and display
                adjustedResult = data;

                // Restore scenario form values
                if (data.scenario) {
                    const s = data.scenario;
                    if (s.pace) document.getElementById('pace').value = s.pace;
                    if (s.track_condition) document.getElementById('trackCondition').value = s.track_condition;
                    if (s.lane_bias) document.getElementById('laneBias').value = s.lane_bias;
                    if (s.style_bias) document.getElementById('styleBias').value = s.style_bias;
                    if (s.notes) document.getElementById('notes').value = s.notes;
                    if (s.front_runner_ids && data.entries) {
                        // Convert horse_ids to umabans
                        const umabans = data.entries
                            .filter(e => s.front_runner_ids.includes(e.horse_id))
                            .map(e => e.umaban);
                        document.getElementById('frontRunners').value = umabans.join(', ');
                    }
                }

                // Display race info and results
                displayRaceInfo(data);
                displayResults(data);

                document.getElementById('scenarioPanel').style.display = 'block';
                document.getElementById('resultsPanel').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';

                // Highlight selected history item
                document.querySelectorAll('.history-item').forEach(el => el.classList.remove('selected'));
                event.target.closest('.history-item').classList.add('selected');

            } catch (error) {
                console.error('Failed to load history item:', error);
                showError('Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó', error.message);
            }
        }
    </script>
</body>
</html>
