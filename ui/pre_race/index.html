<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-race Scenario UI v2.0</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #1a1a2e;
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 1.5rem;
        }
        header .version {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel-header {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group .helper {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #4a90d9;
            color: white;
        }
        .btn-primary:hover {
            background: #357abd;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .race-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .race-info-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .race-info-item .label {
            font-size: 0.8rem;
            color: #666;
        }
        .race-info-item .value {
            font-weight: bold;
        }

        /* Chips */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 40px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chip-default {
            background: #e3f2fd;
            color: #1565c0;
        }
        .chip-default:hover {
            background: #bbdefb;
        }
        .chip-warning {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffb74d;
        }
        .chip-feature {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .chip-applied {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #66bb6a;
        }
        .chip .chip-icon {
            margin-right: 4px;
        }
        .chip-reason {
            font-size: 0.75rem;
            color: #666;
            margin-left: 4px;
        }

        /* Comment box */
        .race-comment {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Table */
        .horse-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .horse-table th,
        .horse-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .horse-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        .horse-table th:hover {
            background: #e9ecef;
        }
        .horse-table th.sorted-asc::after {
            content: " â–²";
            font-size: 0.7rem;
        }
        .horse-table th.sorted-desc::after {
            content: " â–¼";
            font-size: 0.7rem;
        }
        .horse-table tr:hover {
            background: #f5f8ff;
        }
        .umaban {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .umaban-1, .umaban-2 { background: #fff; color: #333; border: 1px solid #333; }
        .umaban-3, .umaban-4 { background: #000; }
        .umaban-5, .umaban-6 { background: #f00; }
        .umaban-7, .umaban-8 { background: #00f; }
        .umaban-9, .umaban-10 { background: #0a0; }
        .umaban-11, .umaban-12 { background: #f80; }
        .umaban-13, .umaban-14 { background: #f0f; }
        .umaban-15, .umaban-16, .umaban-17, .umaban-18 { background: #ff0; color: #333; }

        /* Rank change */
        .rank-change {
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        .rank-up {
            color: #27ae60;
        }
        .rank-down {
            color: #e74c3c;
        }
        .rank-neutral {
            color: #999;
        }
        .prob-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prob-bar-bg {
            flex: 1;
            height: 20px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .prob-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #27ae60);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .prob-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
        }
        .reasons {
            font-size: 0.8rem;
            color: #666;
        }
        .reason-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: #e3f2fd;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        .reason-tag.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .reason-tag.negative {
            background: #ffebee;
            color: #c62828;
        }
        .horse-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .horse-tag {
            font-size: 0.7rem;
            padding: 2px 5px;
            background: #f0f0f0;
            border-radius: 3px;
            color: #555;
        }
        .horse-tag.front {
            background: #fff3e0;
            color: #e65100;
        }
        .horse-tag.closer {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #eee;
            border-top-color: #4a90d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tab-btn.active {
            background: #4a90d9;
            color: white;
            border-color: #4a90d9;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .horse-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Pre-race Scenario UI <span class="version">v2.0</span></h1>
    </header>

    <div class="container">
        <!-- Race Selection Panel -->
        <div class="panel">
            <div class="panel-header">1. ãƒ¬ãƒ¼ã‚¹é¸æŠ</div>
            <div class="form-row">
                <div class="form-group" style="flex: 3;">
                    <label for="raceSelect">ãƒ¬ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <select id="raceSelect">
                        <option value="">-- ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠ --</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 0; align-self: flex-end;">
                    <button class="btn btn-primary" onclick="loadRace()">èª­ã¿è¾¼ã¿</button>
                </div>
            </div>
            <div id="raceInfo" class="race-info" style="display: none;"></div>
        </div>

        <!-- Scenario Input Panel -->
        <div class="panel" id="scenarioPanel" style="display: none;">
            <div class="panel-header">2. ã‚·ãƒŠãƒªã‚ªå…¥åŠ›</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="pace">ãƒšãƒ¼ã‚¹äºˆæƒ³</label>
                    <select id="pace">
                        <option value="S">S (ã‚¹ãƒ­ãƒ¼)</option>
                        <option value="M" selected>M (ãƒŸãƒ‰ãƒ«)</option>
                        <option value="H">H (ãƒã‚¤)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trackCondition">é¦¬å ´çŠ¶æ…‹</label>
                    <select id="trackCondition">
                        <option value="è‰¯" selected>è‰¯</option>
                        <option value="ç¨é‡">ç¨é‡</option>
                        <option value="é‡">é‡</option>
                        <option value="ä¸è‰¯">ä¸è‰¯</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="laneBias">é€²è·¯ãƒã‚¤ã‚¢ã‚¹ï¼ˆã©ã®ãƒ©ã‚¤ãƒ³ãŒä¼¸ã³ã‚‹ã‹ï¼‰</label>
                    <select id="laneBias">
                        <option value="inner">å†…ä¼¸ã³</option>
                        <option value="middle">ä¸­å¤®ãŒè‰¯ã„</option>
                        <option value="outer">å¤–ä¼¸ã³</option>
                        <option value="flat" selected>ãƒ•ãƒ©ãƒƒãƒˆï¼ˆãƒã‚¤ã‚¢ã‚¹ãªã—ï¼‰</option>
                    </select>
                    <div class="helper">é¦¬å ´ã®ã©ã®ä½ç½®ãŒèµ°ã‚Šã‚„ã™ã„ã‹</div>
                </div>
                <div class="form-group">
                    <label for="styleBias">è„šè³ªãƒã‚¤ã‚¢ã‚¹ï¼ˆå‰æ®‹ã‚Š/å·®ã—å±Šãï¼‰</label>
                    <select id="styleBias">
                        <option value="front">å‰æ®‹ã‚Šå‚¾å‘</option>
                        <option value="closer">å·®ã—ãƒ»è¿½è¾¼ãŒå±Šã</option>
                        <option value="flat" selected>ãƒ•ãƒ©ãƒƒãƒˆï¼ˆãƒã‚¤ã‚¢ã‚¹ãªã—ï¼‰</option>
                    </select>
                    <div class="helper">é€ƒã’ãƒ»å…ˆè¡Œ or å·®ã—ãƒ»è¿½è¾¼ã®ã©ã¡ã‚‰ãŒæœ‰åˆ©ã‹</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="frontRunners">é€ƒã’æƒ³å®šé¦¬ï¼ˆé¦¬ç•ªã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                    <input type="text" id="frontRunners" placeholder="ä¾‹: 1, 5, 8">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="notes">ãƒ¡ãƒ¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ææ¡ˆãƒãƒƒãƒ—ã‚’ç”Ÿæˆï¼‰</label>
                    <textarea id="notes" placeholder="ä¾‹: é–‹å¹•é€±ã®é«˜é€Ÿé¦¬å ´ã§å†…æ ã€å‰æœ‰åˆ©ã«ãªã£ã¦ã‚‹ã€‚ç¬ç™ºåŠ›ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç³»ã®è¡€çµ±ãŒå¾—æ„ãªè»½ã„èŠã€‚" oninput="debounceAnalyzeMemo()"></textarea>
                    <div class="helper">å…¥åŠ›ã™ã‚‹ã¨ææ¡ˆãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã€‚</div>
                </div>
            </div>

            <!-- Suggestion Chips -->
            <div id="chipsContainer" class="chips-container" style="display: none;">
                <span style="color: #666; font-size: 0.85rem;">ææ¡ˆãƒãƒƒãƒ—: </span>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="applyScenario()">ã‚·ãƒŠãƒªã‚ªã‚’é©ç”¨</button>
                <button class="btn btn-secondary" onclick="resetScenario()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="resultsPanel" style="display: none;">
            <div class="panel-header">3. è£œæ­£çµæœ</div>

            <!-- Race Comment -->
            <div id="raceComment" class="race-comment" style="display: none;"></div>

            <!-- Tabs for win/in3 -->
            <div class="tab-buttons">
                <button class="tab-btn active" data-target="win" onclick="switchTab('win')">å‹ç‡ (Win)</button>
                <button class="tab-btn" data-target="in3" onclick="switchTab('in3')">è¤‡å‹ç‡ (In3)</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="horse-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th data-sort="umaban">æ </th>
                            <th data-sort="name">é¦¬å</th>
                            <th data-sort="jockey">é¨æ‰‹</th>
                            <th data-sort="run_style">è„šè³ª</th>
                            <th data-sort="tags">ã‚¿ã‚°</th>
                            <th data-sort="base_rank">ãƒ™ãƒ¼ã‚¹é †</th>
                            <th data-sort="adj_rank">è£œæ­£é †</th>
                            <th data-sort="rank_change">é †ä½å¤‰åŒ–</th>
                            <th data-sort="base_p">ãƒ™ãƒ¼ã‚¹ç¢ºç‡</th>
                            <th data-sort="adj_p">è£œæ­£ç¢ºç‡</th>
                            <th>è£œæ­£ç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="saveResult()">çµæœã‚’ä¿å­˜</button>
            </div>
            <div id="saveStatus"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <h3>ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <p>artifacts/pre_race/ ã«ã‚ã‚‹ãƒ¬ãƒ¼ã‚¹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
        </div>
    </div>

    <script>
        // Global state
        let currentRaceData = null;
        let adjustedResult = null;
        let currentTab = 'win';
        let currentSort = { key: 'umaban', order: 'asc' };
        let appliedChips = new Set();
        let memoDebounceTimer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRaceList();
            setupTableHeaders();
        });

        // Setup table header click sorting
        function setupTableHeaders() {
            document.querySelectorAll('.horse-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (currentSort.key === key) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = key;
                        currentSort.order = 'asc';
                    }
                    updateSortIndicators();
                    if (adjustedResult) {
                        displayResults(adjustedResult);
                    }
                });
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('.horse-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const activeTh = document.querySelector(`.horse-table th[data-sort="${currentSort.key}"]`);
            if (activeTh) {
                activeTh.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        // Load race list from server
        async function loadRaceList() {
            try {
                const response = await fetch('/api/list-races');
                const data = await response.json();

                const select = document.getElementById('raceSelect');
                select.innerHTML = '<option value="">-- ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠ --</option>';

                if (data.races && data.races.length > 0) {
                    data.races.forEach(race => {
                        const option = document.createElement('option');
                        option.value = race.path;
                        option.textContent = race.label || `${race.date} - ${race.race_id}`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "(ãƒ¬ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)";
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load race list:', error);
            }
        }

        // Load selected race
        async function loadRace() {
            const select = document.getElementById('raceSelect');
            const path = select.value;

            if (!path) {
                alert('ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`/api/load-race?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (data.error) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                    return;
                }

                currentRaceData = data;
                displayRaceInfo(data);
                document.getElementById('scenarioPanel').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'none';

            } catch (error) {
                console.error('Failed to load race:', error);
                alert('ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Display race info
        function displayRaceInfo(data) {
            const infoDiv = document.getElementById('raceInfo');
            infoDiv.innerHTML = `
                <div class="race-info-item">
                    <div class="label">ãƒ¬ãƒ¼ã‚¹ID</div>
                    <div class="value">${data.race_id || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">æ—¥ä»˜</div>
                    <div class="value">${data.date || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">å ´æ‰€</div>
                    <div class="value">${data.place || '-'} ${data.race_no || ''}R</div>
                </div>
                <div class="race-info-item">
                    <div class="label">ãƒ¬ãƒ¼ã‚¹å</div>
                    <div class="value">${data.name || data.race_name || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">è·é›¢</div>
                    <div class="value">${data.distance || '-'}m ${data.course || ''}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">å‡ºèµ°é ­æ•°</div>
                    <div class="value">${data.entries ? data.entries.length : 0}é ­</div>
                </div>
            `;
            infoDiv.style.display = 'grid';
        }

        // Debounced memo analysis
        function debounceAnalyzeMemo() {
            if (memoDebounceTimer) {
                clearTimeout(memoDebounceTimer);
            }
            memoDebounceTimer = setTimeout(analyzeMemo, 500);
        }

        // Analyze memo and generate chips
        async function analyzeMemo() {
            const memo = document.getElementById('notes').value;
            const container = document.getElementById('chipsContainer');

            if (!memo.trim()) {
                container.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/parse-memo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memo: memo }),
                });

                const data = await response.json();

                if (data.error) {
                    console.error('Memo parse error:', data.error);
                    return;
                }

                displayChips(data.chips || []);

            } catch (error) {
                console.error('Failed to analyze memo:', error);
            }
        }

        // Display suggestion chips
        function displayChips(chips) {
            const container = document.getElementById('chipsContainer');

            if (chips.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = '<span style="color: #666; font-size: 0.85rem; align-self: center;">ææ¡ˆ: </span>';

            chips.forEach(chip => {
                const chipEl = document.createElement('span');
                chipEl.className = 'chip';

                if (chip.is_warning) {
                    chipEl.className += ' chip-warning';
                    chipEl.innerHTML = `<span class="chip-icon">âš ï¸</span>${chip.label}`;
                } else if (chip.needs_feature) {
                    chipEl.className += ' chip-feature';
                    chipEl.innerHTML = `<span class="chip-icon">ğŸ“Œ</span>${chip.label}`;
                    chipEl.title = 'å°†æ¥ç‰¹å¾´é‡åŒ–å€™è£œï¼ˆç¾åœ¨ã¯è£œæ­£ã«ä½¿ç”¨ã—ã¾ã›ã‚“ï¼‰';
                } else if (appliedChips.has(chip.id)) {
                    chipEl.className += ' chip-applied';
                    chipEl.innerHTML = `<span class="chip-icon">âœ“</span>${chip.label}`;
                } else {
                    chipEl.className += ' chip-default';
                    chipEl.innerHTML = chip.label;
                    chipEl.onclick = () => applyChip(chip);
                }

                container.appendChild(chipEl);
            });
        }

        // Apply chip to form
        function applyChip(chip) {
            const payload = chip.apply_payload || {};

            if (payload.track_condition) {
                document.getElementById('trackCondition').value = payload.track_condition;
            }
            if (payload.lane_bias) {
                document.getElementById('laneBias').value = payload.lane_bias;
            }
            if (payload.style_bias) {
                document.getElementById('styleBias').value = payload.style_bias;
            }
            if (payload.pace) {
                document.getElementById('pace').value = payload.pace;
            }

            appliedChips.add(chip.id);

            // Re-analyze to update chip display
            analyzeMemo();
        }

        // Apply scenario
        async function applyScenario() {
            if (!currentRaceData) {
                alert('ãƒ¬ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            // Parse front runners
            const frontRunnersInput = document.getElementById('frontRunners').value;
            const frontRunnerUmabans = frontRunnersInput
                .split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));

            // Map umaban to horse_id
            const frontRunnerIds = currentRaceData.entries
                .filter(e => frontRunnerUmabans.includes(e.umaban))
                .map(e => e.horse_id);

            const scenario = {
                pace: document.getElementById('pace').value,
                track_condition: document.getElementById('trackCondition').value,
                lane_bias: document.getElementById('laneBias').value,
                style_bias: document.getElementById('styleBias').value,
                front_runner_ids: frontRunnerIds,
                notes: document.getElementById('notes').value,
            };

            try {
                const response = await fetch('/api/apply-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        race_data: currentRaceData,
                        scenario: scenario,
                    }),
                });

                const result = await response.json();

                if (result.error) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    return;
                }

                adjustedResult = result;
                displayResults(result);
                document.getElementById('resultsPanel').style.display = 'block';

            } catch (error) {
                console.error('Failed to apply scenario:', error);
                alert('ã‚·ãƒŠãƒªã‚ªé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Switch between win/in3 tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === tab);
            });
            if (adjustedResult) {
                displayResults(adjustedResult);
            }
        }

        // Display results
        function displayResults(result) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            // Display race comment
            const commentDiv = document.getElementById('raceComment');
            if (result.race_comment) {
                commentDiv.textContent = result.race_comment;
                commentDiv.style.display = 'block';
            } else {
                commentDiv.style.display = 'none';
            }

            // Sort entries
            const entries = [...result.entries];
            sortEntries(entries);

            entries.forEach(entry => {
                const row = document.createElement('tr');

                // Get values based on current tab
                const baseRank = currentTab === 'win' ? entry.base_rank_win : entry.base_rank_in3;
                const adjRank = currentTab === 'win' ? entry.adj_rank_win : entry.adj_rank_in3;
                const rankChange = currentTab === 'win' ? entry.rank_change_win : entry.rank_change_in3;
                const baseP = currentTab === 'win' ? entry.base_p_win : entry.base_p_in3;
                const adjP = currentTab === 'win' ? entry.adj_p_win : entry.adj_p_in3;

                // Rank change styling
                let rankChangeClass = 'rank-neutral';
                let rankChangeText = 'â†’';
                if (rankChange > 0) {
                    rankChangeClass = 'rank-up';
                    rankChangeText = `â†‘${rankChange}`;
                } else if (rankChange < 0) {
                    rankChangeClass = 'rank-down';
                    rankChangeText = `â†“${Math.abs(rankChange)}`;
                }

                // Reason tags
                const reasonTags = (entry.reasons || []).map(r => {
                    const isPositive = r.includes('æœ‰åˆ©') || r.includes('é€ƒã’æƒ³å®š');
                    const isNegative = r.includes('ä¸åˆ©') || r.includes('æ¸›è¡°');
                    let tagClass = 'reason-tag';
                    if (isPositive) tagClass += ' positive';
                    if (isNegative) tagClass += ' negative';
                    return `<span class="${tagClass}">${r}</span>`;
                }).join('');

                // Horse tags
                const horseTags = (entry.tags || []).map(t => {
                    let tagClass = 'horse-tag';
                    if (t.includes('é€ƒã’') || t.includes('å…ˆè¡Œ')) tagClass += ' front';
                    if (t.includes('å·®ã—') || t.includes('è¿½è¾¼')) tagClass += ' closer';
                    return `<span class="${tagClass}">${t}</span>`;
                }).join('');

                // Probability bar
                const probPercent = Math.min(100, (adjP || 0) * 100 * 5);

                row.innerHTML = `
                    <td><span class="umaban umaban-${entry.umaban}">${entry.umaban}</span></td>
                    <td><strong>${entry.name || '-'}</strong></td>
                    <td>${entry.jockey || '-'}</td>
                    <td>${entry.run_style || '-'}</td>
                    <td><div class="horse-tags">${horseTags || '-'}</div></td>
                    <td style="text-align: center;">${baseRank || '-'}</td>
                    <td style="text-align: center; font-weight: bold;">${adjRank || '-'}</td>
                    <td class="rank-change ${rankChangeClass}">${rankChangeText}</td>
                    <td>${((baseP || 0) * 100).toFixed(1)}%</td>
                    <td>
                        <div class="prob-bar">
                            <div class="prob-bar-bg">
                                <div class="prob-bar-fill" style="width: ${probPercent}%"></div>
                            </div>
                            <span class="prob-value">${((adjP || 0) * 100).toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="reasons">${reasonTags || '-'}</td>
                `;

                tbody.appendChild(row);
            });

            updateSortIndicators();
        }

        // Sort entries
        function sortEntries(entries) {
            const key = currentSort.key;
            const order = currentSort.order;

            entries.sort((a, b) => {
                let valA, valB;

                switch (key) {
                    case 'umaban':
                        valA = a.umaban || 0;
                        valB = b.umaban || 0;
                        break;
                    case 'name':
                        valA = a.name || '';
                        valB = b.name || '';
                        break;
                    case 'jockey':
                        valA = a.jockey || '';
                        valB = b.jockey || '';
                        break;
                    case 'run_style':
                        const styleOrder = { 'é€ƒã’': 1, 'å…ˆè¡Œ': 2, 'å·®ã—': 3, 'è¿½è¾¼': 4, 'ä¸æ˜': 5 };
                        valA = styleOrder[a.run_style] || 5;
                        valB = styleOrder[b.run_style] || 5;
                        break;
                    case 'tags':
                        valA = (a.tags || []).length;
                        valB = (b.tags || []).length;
                        break;
                    case 'base_rank':
                        valA = currentTab === 'win' ? (a.base_rank_win || 99) : (a.base_rank_in3 || 99);
                        valB = currentTab === 'win' ? (b.base_rank_win || 99) : (b.base_rank_in3 || 99);
                        break;
                    case 'adj_rank':
                        valA = currentTab === 'win' ? (a.adj_rank_win || 99) : (a.adj_rank_in3 || 99);
                        valB = currentTab === 'win' ? (b.adj_rank_win || 99) : (b.adj_rank_in3 || 99);
                        break;
                    case 'rank_change':
                        valA = currentTab === 'win' ? (a.rank_change_win || 0) : (a.rank_change_in3 || 0);
                        valB = currentTab === 'win' ? (b.rank_change_win || 0) : (b.rank_change_in3 || 0);
                        break;
                    case 'base_p':
                        valA = currentTab === 'win' ? (a.base_p_win || 0) : (a.base_p_in3 || 0);
                        valB = currentTab === 'win' ? (b.base_p_win || 0) : (b.base_p_in3 || 0);
                        break;
                    case 'adj_p':
                        valA = currentTab === 'win' ? (a.adj_p_win || 0) : (a.adj_p_in3 || 0);
                        valB = currentTab === 'win' ? (b.adj_p_win || 0) : (b.adj_p_in3 || 0);
                        break;
                    default:
                        valA = a.umaban || 0;
                        valB = b.umaban || 0;
                }

                if (typeof valA === 'string') {
                    return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return order === 'asc' ? valA - valB : valB - valA;
            });
        }

        // Reset scenario
        function resetScenario() {
            document.getElementById('pace').value = 'M';
            document.getElementById('trackCondition').value = 'è‰¯';
            document.getElementById('laneBias').value = 'flat';
            document.getElementById('styleBias').value = 'flat';
            document.getElementById('frontRunners').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('chipsContainer').style.display = 'none';
            adjustedResult = null;
            appliedChips.clear();
        }

        // Save result
        async function saveResult() {
            if (!adjustedResult) {
                alert('ä¿å­˜ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result: adjustedResult }),
                });

                const data = await response.json();

                const statusDiv = document.getElementById('saveStatus');
                if (data.status === 'saved') {
                    statusDiv.innerHTML = `<div class="status-message status-success">ä¿å­˜ã—ã¾ã—ãŸ: ${data.path}</div>`;
                } else if (data.error) {
                    statusDiv.innerHTML = `<div class="status-message status-error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                }

                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('Failed to save result:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>
