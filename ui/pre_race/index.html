<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-race Scenario UI</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #1a1a2e;
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 1.5rem;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel-header {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 150px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #4a90d9;
            color: white;
        }
        .btn-primary:hover {
            background: #357abd;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .race-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .race-info-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .race-info-item .label {
            font-size: 0.8rem;
            color: #666;
        }
        .race-info-item .value {
            font-weight: bold;
        }
        .horse-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .horse-table th,
        .horse-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .horse-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .horse-table tr:hover {
            background: #f5f8ff;
        }
        .umaban {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .umaban-1, .umaban-2 { background: #fff; color: #333; border: 1px solid #333; }
        .umaban-3, .umaban-4 { background: #000; }
        .umaban-5, .umaban-6 { background: #f00; }
        .umaban-7, .umaban-8 { background: #00f; }
        .umaban-9, .umaban-10 { background: #0a0; }
        .umaban-11, .umaban-12 { background: #f80; }
        .umaban-13, .umaban-14 { background: #f0f; }
        .umaban-15, .umaban-16, .umaban-17, .umaban-18 { background: #ff0; color: #333; }
        .delta {
            font-weight: bold;
            text-align: center;
        }
        .delta-up {
            color: #27ae60;
        }
        .delta-down {
            color: #e74c3c;
        }
        .delta-neutral {
            color: #999;
        }
        .prob-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prob-bar-bg {
            flex: 1;
            height: 20px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .prob-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #27ae60);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .prob-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
        }
        .reasons {
            font-size: 0.8rem;
            color: #666;
        }
        .reason-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: #e3f2fd;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        .reason-tag.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .reason-tag.negative {
            background: #ffebee;
            color: #c62828;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #eee;
            border-top-color: #4a90d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        .sort-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .sort-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .sort-btn.active {
            background: #4a90d9;
            color: white;
            border-color: #4a90d9;
        }
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .horse-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Pre-race Scenario UI</h1>
    </header>

    <div class="container">
        <!-- Race Selection Panel -->
        <div class="panel">
            <div class="panel-header">1. レース選択</div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="raceSelect">レースファイル</label>
                    <select id="raceSelect">
                        <option value="">-- レースを選択 --</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 0; align-self: flex-end;">
                    <button class="btn btn-primary" onclick="loadRace()">読み込み</button>
                </div>
            </div>
            <div id="raceInfo" class="race-info" style="display: none;"></div>
        </div>

        <!-- Scenario Input Panel -->
        <div class="panel" id="scenarioPanel" style="display: none;">
            <div class="panel-header">2. シナリオ入力</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="pace">ペース予想</label>
                    <select id="pace">
                        <option value="S">S (スロー)</option>
                        <option value="M" selected>M (ミドル)</option>
                        <option value="H">H (ハイ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trackCondition">馬場状態</label>
                    <select id="trackCondition">
                        <option value="良" selected>良</option>
                        <option value="稍重">稍重</option>
                        <option value="重">重</option>
                        <option value="不良">不良</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bias">バイアス</label>
                    <select id="bias">
                        <option value="内">内伸び</option>
                        <option value="フラット" selected>フラット</option>
                        <option value="外">外伸び</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="frontRunners">逃げ想定馬（馬番をカンマ区切り）</label>
                    <input type="text" id="frontRunners" placeholder="例: 1, 5, 8">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="notes">メモ</label>
                    <textarea id="notes" placeholder="シナリオの根拠など"></textarea>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="applyScenario()">シナリオを適用</button>
                <button class="btn btn-secondary" onclick="resetScenario()">リセット</button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel" id="resultsPanel" style="display: none;">
            <div class="panel-header">3. 補正結果</div>

            <div class="sort-selector">
                <span style="align-self: center; margin-right: 10px;">並び替え:</span>
                <button class="sort-btn active" data-sort="umaban" onclick="sortTable('umaban')">馬番順</button>
                <button class="sort-btn" data-sort="adj_rank_win" onclick="sortTable('adj_rank_win')">勝率順</button>
                <button class="sort-btn" data-sort="delta" onclick="sortTable('delta')">Δ順</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="horse-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>枠</th>
                            <th>馬名</th>
                            <th>騎手</th>
                            <th>脚質</th>
                            <th>Base順</th>
                            <th>補正順</th>
                            <th>Δ</th>
                            <th>Base確率</th>
                            <th>補正確率</th>
                            <th>補正理由</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="saveResult()">結果を保存</button>
            </div>
            <div id="saveStatus"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <h3>レースを選択してください</h3>
            <p>artifacts/pre_race/ にあるレースJSONファイルを読み込みます</p>
        </div>
    </div>

    <script>
        // Global state
        let currentRaceData = null;
        let adjustedResult = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRaceList();
        });

        // Load race list from server
        async function loadRaceList() {
            try {
                const response = await fetch('/api/list-races');
                const data = await response.json();

                const select = document.getElementById('raceSelect');
                select.innerHTML = '<option value="">-- レースを選択 --</option>';

                if (data.races && data.races.length > 0) {
                    data.races.forEach(race => {
                        const option = document.createElement('option');
                        option.value = race.path;
                        option.textContent = `${race.date} - ${race.race_id}`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "(レースファイルが見つかりません)";
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load race list:', error);
            }
        }

        // Load selected race
        async function loadRace() {
            const select = document.getElementById('raceSelect');
            const path = select.value;

            if (!path) {
                alert('レースを選択してください');
                return;
            }

            try {
                const response = await fetch(`/api/load-race?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (data.error) {
                    alert(`エラー: ${data.error}`);
                    return;
                }

                currentRaceData = data;
                displayRaceInfo(data);
                document.getElementById('scenarioPanel').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'none';

            } catch (error) {
                console.error('Failed to load race:', error);
                alert('レースデータの読み込みに失敗しました');
            }
        }

        // Display race info
        function displayRaceInfo(data) {
            const infoDiv = document.getElementById('raceInfo');
            infoDiv.innerHTML = `
                <div class="race-info-item">
                    <div class="label">レースID</div>
                    <div class="value">${data.race_id || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">日付</div>
                    <div class="value">${data.date || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">場所</div>
                    <div class="value">${data.place || '-'} ${data.race_no || ''}R</div>
                </div>
                <div class="race-info-item">
                    <div class="label">レース名</div>
                    <div class="value">${data.name || '-'}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">距離</div>
                    <div class="value">${data.distance || '-'}m ${data.course || ''}</div>
                </div>
                <div class="race-info-item">
                    <div class="label">出走頭数</div>
                    <div class="value">${data.entries ? data.entries.length : 0}頭</div>
                </div>
            `;
            infoDiv.style.display = 'grid';
        }

        // Apply scenario
        async function applyScenario() {
            if (!currentRaceData) {
                alert('レースを読み込んでください');
                return;
            }

            // Parse front runners
            const frontRunnersInput = document.getElementById('frontRunners').value;
            const frontRunnerUmabans = frontRunnersInput
                .split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));

            // Map umaban to horse_id
            const frontRunnerIds = currentRaceData.entries
                .filter(e => frontRunnerUmabans.includes(e.umaban))
                .map(e => e.horse_id);

            const scenario = {
                pace: document.getElementById('pace').value,
                track_condition: document.getElementById('trackCondition').value,
                bias: document.getElementById('bias').value,
                front_runner_ids: frontRunnerIds,
                notes: document.getElementById('notes').value,
            };

            try {
                const response = await fetch('/api/apply-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        race_data: currentRaceData,
                        scenario: scenario,
                    }),
                });

                const result = await response.json();

                if (result.error) {
                    alert(`エラー: ${result.error}`);
                    return;
                }

                adjustedResult = result;
                displayResults(result);
                document.getElementById('resultsPanel').style.display = 'block';

            } catch (error) {
                console.error('Failed to apply scenario:', error);
                alert('シナリオ適用に失敗しました');
            }
        }

        // Display results
        function displayResults(result) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            result.entries.forEach(entry => {
                const row = document.createElement('tr');

                // Delta styling
                const delta = entry.delta_rank_win || 0;
                let deltaClass = 'delta-neutral';
                let deltaText = '→';
                if (delta > 0) {
                    deltaClass = 'delta-up';
                    deltaText = `↑${delta}`;
                } else if (delta < 0) {
                    deltaClass = 'delta-down';
                    deltaText = `↓${Math.abs(delta)}`;
                }

                // Reason tags
                const reasonTags = (entry.reasons || []).map(r => {
                    const isPositive = r.includes('有利') || r.includes('逃げ想定');
                    const isNegative = r.includes('不利') || r.includes('減衰');
                    let tagClass = 'reason-tag';
                    if (isPositive) tagClass += ' positive';
                    if (isNegative) tagClass += ' negative';
                    return `<span class="${tagClass}">${r}</span>`;
                }).join('');

                // Probability bar
                const probPercent = Math.min(100, (entry.adj_p_win || 0) * 100 * 5); // Scale for visibility

                row.innerHTML = `
                    <td><span class="umaban umaban-${entry.umaban}">${entry.umaban}</span></td>
                    <td><strong>${entry.name || '-'}</strong></td>
                    <td>${entry.jockey || '-'}</td>
                    <td>${entry.run_style || '-'}</td>
                    <td style="text-align: center;">${entry.base_rank_win || '-'}</td>
                    <td style="text-align: center; font-weight: bold;">${entry.adj_rank_win || '-'}</td>
                    <td class="delta ${deltaClass}">${deltaText}</td>
                    <td>${((entry.base_p_win || 0) * 100).toFixed(1)}%</td>
                    <td>
                        <div class="prob-bar">
                            <div class="prob-bar-bg">
                                <div class="prob-bar-fill" style="width: ${probPercent}%"></div>
                            </div>
                            <span class="prob-value">${((entry.adj_p_win || 0) * 100).toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="reasons">${reasonTags || '-'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Sort table
        function sortTable(sortKey) {
            if (!adjustedResult) return;

            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === sortKey);
            });

            // Sort entries
            const entries = [...adjustedResult.entries];

            if (sortKey === 'umaban') {
                entries.sort((a, b) => (a.umaban || 0) - (b.umaban || 0));
            } else if (sortKey === 'adj_rank_win') {
                entries.sort((a, b) => (a.adj_rank_win || 99) - (b.adj_rank_win || 99));
            } else if (sortKey === 'delta') {
                entries.sort((a, b) => (b.delta_rank_win || 0) - (a.delta_rank_win || 0));
            }

            adjustedResult.entries = entries;
            displayResults(adjustedResult);
        }

        // Reset scenario
        function resetScenario() {
            document.getElementById('pace').value = 'M';
            document.getElementById('trackCondition').value = '良';
            document.getElementById('bias').value = 'フラット';
            document.getElementById('frontRunners').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('resultsPanel').style.display = 'none';
            adjustedResult = null;
        }

        // Save result
        async function saveResult() {
            if (!adjustedResult) {
                alert('保存する結果がありません');
                return;
            }

            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result: adjustedResult }),
                });

                const data = await response.json();

                const statusDiv = document.getElementById('saveStatus');
                if (data.status === 'saved') {
                    statusDiv.innerHTML = `<div class="status-message status-success">保存しました: ${data.path}</div>`;
                } else if (data.error) {
                    statusDiv.innerHTML = `<div class="status-message status-error">エラー: ${data.error}</div>`;
                }

                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('Failed to save result:', error);
                alert('保存に失敗しました');
            }
        }
    </script>
</body>
</html>
